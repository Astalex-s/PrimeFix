services:  # описание всех сервисов (контейнеров), входящих в стек
  nginx:
    image: nginx:alpine  # официальный легковесный образ Nginx
    container_name: nginx  # читаемое имя контейнера
    depends_on:
      - postgres  # запускать после PostgreSQL (для зависимых маршрутов)
      - pgadmin   # запускать после pgAdmin (для удобства, не обязательно)
      # - backend  # будет активирован при реализации бэкенда
    ports:
      - "0.0.0.0:80:80"  # проброс порта 80 хоста на порт 80 контейнера (доступ с любого интерфейса)
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro  # подключаем нашу конфигурацию Nginx только для чтения
    networks:
      - internal  # используем внутреннюю изолированную сеть

  postgres:
    image: postgres:16-alpine  # образ PostgreSQL (версия 16 на базе Alpine)
    container_name: postgres  # имя контейнера базы данных
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-app_db}              # имя создаваемой БД по умолчанию
      POSTGRES_USER: ${POSTGRES_USER:-app_user}        # пользователь БД
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me}  # пароль пользователя (заменить в реальной среде)
    volumes:
      - postgres_data:/var/lib/postgresql/data  # постоянное хранение данных БД в docker-томе
    networks:
      - internal  # база доступна только внутри внутренней сети

  pgadmin:
    image: dpage/pgadmin4:8
    container_name: pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-change_me}
      PGADMIN_LISTEN_PORT: ${PGADMIN_LISTEN_PORT:-80}
      SCRIPT_NAME: /pgadmin
      # Доверять заголовкам X-Forwarded от Nginx (иначе редиректы/сессия за прокси ломаются)
      PROXY_X_FOR_COUNT: 1
      PROXY_X_PROTO_COUNT: 1
      PROXY_X_HOST_COUNT: 1
      PROXY_X_PREFIX_COUNT: 1
      # Отключить усиленную проверку cookie за reverse proxy (иначе сессия может не сохраняться)
      PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "False"
    ports:
      - "0.0.0.0:5050:80"  # проброс порта 5050 хоста на порт 80 контейнера (интерфейс pgAdmin)
    depends_on:
      - postgres  # запускать после PostgreSQL
    networks:
      - internal  # доступ к PostgreSQL только через внутреннюю сеть

  registry:
    image: registry:2
    container_name: registry
    ports:
      - "0.0.0.0:5000:5000"
    environment:
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: "Registry Realm"
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      REGISTRY_HTTP_SECRET: ${REGISTRY_HTTP_SECRET:-primefix-registry-secret-change-in-production}
    volumes:
      - registry_data:/var/lib/registry  # том для хранения образов реестра
      - ./registry/auth:/auth            # монтируем каталог с файлом htpasswd
    networks:
      - internal  # реестр находится во внутренней сети

  watchtower:
    image: containrrr/watchtower  # образ Watchtower (тег latest)
    container_name: watchtower
    command: --cleanup --interval ${WATCHTOWER_INTERVAL:-300}  # удалять старые образы и проверять обновления каждые N секунд
    environment:
      DOCKER_API_VERSION: ${DOCKER_API_VERSION:-1.44}  # минимальная версия API для связи с демоном (1.44 — если ошибка «client version 1.25 is too old»)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # доступ к Docker API хоста для управления контейнерами
    networks:
      - internal

  # backend:
  #   image: ${BACKEND_IMAGE:-backend-image:latest}  # образ бэкенда (по умолчанию backend-image:latest или значение из .env)
  #   container_name: backend      # имя контейнера бэкенда
  #   restart: always              # автоматически перезапускать контейнер при сбоях
  #   environment:
  #     # TODO: добавить переменные окружения для подключения к PostgreSQL (настроить при реализации бэкенда)
  #     # DB_HOST=${BACKEND_DB_HOST:-postgres}      # адрес сервиса PostgreSQL во внутренней сети
  #     # DB_PORT=${BACKEND_DB_PORT:-5432}          # порт PostgreSQL во внутренней сети
  #     # DB_NAME=${BACKEND_DB_NAME:-app_db}        # имя базы данных
  #     # DB_USER=${BACKEND_DB_USER:-app_user}      # пользователь базы данных
  #     # DB_PASSWORD=${BACKEND_DB_PASSWORD:-change_me}  # пароль пользователя
  #   depends_on:
  #     - postgres  # запускать после PostgreSQL
  #   networks:
  #     - internal  # доступен только внутри внутренней сети через Nginx

volumes:
  postgres_data:  # том для хранения данных PostgreSQL
  registry_data:  # том для хранения данных Docker Registry

networks:
  internal:
    driver: bridge
    # internal: false — обязательно для работы проброса портов (80, 5050, 5000) на хост.
    # Сеть остаётся изолированной от других стеков; контейнеры доступны только по явно указанным ports.


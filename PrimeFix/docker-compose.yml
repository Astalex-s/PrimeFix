# API и БД не пробрасываются на хост. Внешний доступ только через Nginx (порт 80).
# Раскомментировать pgadmin и/или registry при необходимости.
services:
  nginx:
    build:
      context: .
      dockerfile: Dockerfile.nginx
    image: primefix-nginx:latest
    container_name: nginx
    depends_on:
      - backend
      # - postgres   # раскомментировать при использовании pgadmin
      # - pgadmin    # раскомментировать при использовании pgadmin
    ports:
      - "0.0.0.0:80:80"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    networks:
      - internal

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-app_db}
      POSTGRES_USER: ${POSTGRES_USER:-app_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal

  # --- pgadmin (отключён; раскомментировать для доступа к БД через веб-интерфейс) ---
  # pgadmin:
  #   image: dpage/pgadmin4:8
  #   container_name: pgadmin
  #   environment:
  #     PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
  #     PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD:-change_me}
  #     PGADMIN_LISTEN_PORT: ${PGADMIN_LISTEN_PORT:-80}
  #     SCRIPT_NAME: /pgadmin
  #     PROXY_X_FOR_COUNT: 1
  #     PROXY_X_PROTO_COUNT: 1
  #     PROXY_X_HOST_COUNT: 1
  #     PROXY_X_PREFIX_COUNT: 1
  #     PGADMIN_CONFIG_ENHANCED_COOKIE_PROTECTION: "False"
  #   ports:
  #     - "0.0.0.0:5050:80"
  #   depends_on:
  #     - postgres
  #   networks:
  #     - internal

  # --- Docker Registry (отключён; раскомментировать для приватного реестра образов) ---
  # registry:
  #   image: registry:2
  #   container_name: registry
  #   ports:
  #     - "0.0.0.0:5000:5000"
  #   volumes:
  #     - registry_data:/var/lib/registry
  #   networks:
  #     - internal

  watchtower:
    image: containrrr/watchtower  # образ Watchtower (тег latest)
    container_name: watchtower
    command: --cleanup --interval ${WATCHTOWER_INTERVAL:-300}  # удалять старые образы и проверять обновления каждые N секунд
    environment:
      DOCKER_API_VERSION: ${DOCKER_API_VERSION:-1.44}  # минимальная версия API для связи с демоном (1.44 — если ошибка «client version 1.25 is too old»)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # доступ к Docker API хоста для управления контейнерами
    networks:
      - internal

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    image: ${BACKEND_IMAGE:-primefix-backend:latest}
    container_name: backend
    restart: always
    environment:
      DB_HOST: ${POSTGRES_HOST:-postgres}
      DB_PORT: ${POSTGRES_PORT:-5432}
      DB_NAME: ${POSTGRES_DB:-app_db}
      DB_USER: ${POSTGRES_USER:-app_user}
      DB_PASSWORD: ${POSTGRES_PASSWORD:-change_me}
    depends_on:
      - postgres
    networks:
      - internal
    # Порт на хост не пробрасывается — API доступен только для Nginx по внутренней сети (proxy_pass на backend:8080).

volumes:
  postgres_data:
  # registry_data:  # для registry (раскомментировать вместе с сервисом registry)

networks:
  internal:
    driver: bridge

